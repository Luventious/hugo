name: Deploy Hugo to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false

      # 2. 安装 Python（用于日期处理）
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Fix Notion Flow Dates
        run: |
          python3 <<'EOF'
          import os
          import re

          folder = "content"  # Hugo 内容目录
          for root, dirs, files in os.walk(folder):
              for file in files:
                  if not file.endswith(".md"):
                      continue
                  path = os.path.join(root, file)
                  with open(path, "r", encoding="utf-8") as f:
                      content = f.read()

                  def fix_date(match):
                      y, m, d, H, M, S, tz = match.groups()
                      # 保留 date: key，Hugo 支持 ISO8601 时区格式 +08:00
                      return f"date: {int(y):04d}-{int(m):02d}-{int(d):02d}T{int(H):02d}:{int(M):02d}:{int(S):02d}{tz[:3]}:{tz[3:]}"

                  content_new = re.sub(
                      r"date:\s*(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}) (\+\d{4})",
                      fix_date,
                      content
                  )

                  with open(path, "w", encoding="utf-8") as f:
                      f.write(content_new)
          EOF


      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build site
        run: hugo --minify --baseURL http://112.126.85.212:12085/

      - name: Deploy to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "public/*"
          target: "/var/www/html/"
          strip_components: 1

      - name: Restart Nginx  # 把步骤名称从Reload改为Restart，更贴合实际操作
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          # 核心修改：将reload改为restart，无论Nginx是否启动都能执行
          script: sudo systemctl restart nginx
